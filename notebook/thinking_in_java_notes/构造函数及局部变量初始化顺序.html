<html>
<head>
  <title>构造函数及局部变量初始化顺序</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/304720 (zh-CN, DDL); Windows/10.0.14393 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="822"/>
<h1>构造函数及局部变量初始化顺序</h1>

<div>
<span><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">1. 初始化顺序</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">在一个类里，初始化的顺序是由变量在类内的定义顺序决定的。即使变量定义大量遍布于方法定义的中间，</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">那些变量仍会在调用任何方法之前得到初始化——甚至在构建器调用之前。例如：</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">//: OrderOfInitialization.java</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">// Demonstrates initialization order.</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">// When the constructor is called, to create a</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">// Tag object, you'll see a message:</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">class Tag {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Tag(int marker) {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">System.out.println(&quot;Tag(&quot; + marker + &quot;)&quot;);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">class Card {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Tag t1 = new Tag(1); // Before constructor</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Card() {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">// Indicate we're in the constructor:</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">System.out.println(&quot;Card()&quot;);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">t3 = new Tag(33); // Re-initialize t3</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Tag t2 = new Tag(2); // After constructor</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">void f() {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">System.out.println(&quot;f()&quot;);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Tag t3 = new Tag(3); // At end</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">public class OrderOfInitialization {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">public static void main(String[] args) {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Card t = new Card();</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">t.f(); // Shows that construction is done</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">112</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">} ///:~</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">在Card 中，Tag 对象的定义故意到处散布，以证明它们全都会在构建器进入或者发生其他任何事情之前得到</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">初始化。除此之外，t3 在构建器内部得到了重新初始化。它的输入结果如下：</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Tag(1)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Tag(2)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Tag(3)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Card()</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Tag(33)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">f()</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">因此，t3 句柄会被初始化两次，一次在构建器调用前，一次在调用期间（第一个对象会被丢弃，所以它后来</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">可被当作垃圾收掉）。从表面看，这样做似乎效率低下，但它能保证正确的初始化——若定义了一个过载的</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">构建器，它没有初始化t3；同时在t3 的定义里并没有规定“默认”的初始化方式，那么会产生什么后果</span></font></div><div align="left" style="min-height: 12pt;"><div><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">呢？</span></font></div><div><span style="font-family: 宋体;"><span style="color: rgb(1, 1, 1);"><br/></span></span></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">2. 静态数据的初始化</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">若数据是静态的（static），那么同样的事情就会发生；如果它属于一个基本类型（主类型），而且未对其</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">初始化，就会自动获得自己的标准基本类型初始值；如果它是指向一个对象的句柄，那么除非新建一个对</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">象，并将句柄同它连接起来，否则就会得到一个空值（NULL）。</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">如果想在定义的同时进行初始化，采取的方法与非静态值表面看起来是相同的。但由于static 值只有一个存</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">储区域，所以无论创建多少个对象，都必然会遇到何时对那个存储区域进行初始化的问题。下面这个例子可</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">将这个问题说更清楚一些：</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">//: StaticInitialization.java</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">// Specifying initial values in a</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">// class definition.</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">class Bowl {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Bowl(int marker) {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">System.out.println(&quot;Bowl(&quot; + marker + &quot;)&quot;);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">void f(int marker) {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">System.out.println(&quot;f(&quot; + marker + &quot;)&quot;);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">class Table {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">static Bowl b1 = new Bowl(1);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Table() {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">System.out.println(&quot;Table()&quot;);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">b2.f(1);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">void f2(int marker) {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">System.out.println(&quot;f2(&quot; + marker + &quot;)&quot;);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">static Bowl b2 = new Bowl(2);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">class Cupboard {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Bowl b3 = new Bowl(3);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">113</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">static Bowl b4 = new Bowl(4);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Cupboard() {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">System.out.println(&quot;Cupboard()&quot;);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">b4.f(2);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">void f3(int marker) {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">System.out.println(&quot;f3(&quot; + marker + &quot;)&quot;);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">static Bowl b5 = new Bowl(5);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">public class StaticInitialization {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">public static void main(String[] args) {</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">System.out.println(</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&quot;Creating new Cupboard() in main&quot;);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">new Cupboard();</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">System.out.println(</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">&quot;Creating new Cupboard() in main&quot;);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">new Cupboard();</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">t2.f2(1);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">t3.f3(1);</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">}</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">static Table t2 = new Table();</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">static Cupboard t3 = new Cupboard();</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">} ///:~</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Bowl 允许我们检查一个类的创建过程，而Table 和Cupboard 能创建散布于类定义中的Bowl 的static 成</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">员。注意在static 定义之前，Cupboard 先创建了一个非static 的Bowl b3。它的输出结果如下：</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Bowl(1)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Bowl(2)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Table()</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">f(1)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Bowl(4)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Bowl(5)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Bowl(3)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Cupboard()</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">f(2)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Creating new Cupboard() in main</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Bowl(3)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Cupboard()</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">f(2)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Creating new Cupboard() in main</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Bowl(3)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Cupboard()</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">f(2)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">f2(1)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">f3(1)</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">static 初始化只有在必要的时候才会进行。如果不创建一个Table 对象，而且永远都不引用Table.b1 或</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">Table.b2，那么static Bowl b1 和b2 永远都不会创建。然而，只有在创建了第一个Table 对象之后（或者</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">发生了第一次static 访问），它们才会创建。在那以后，static 对象不会重新初始化。</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">114</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">初始化的顺序是首先static（如果它们尚未由前一次对象创建过程初始化），接着是非static 对象。大家</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">可从输出结果中找到相应的证据。</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">在这里有必要总结一下对象的创建过程。请考虑一个名为Dog 的类：</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">(1) 类型为Dog 的一个对象首次创建时，或者Dog 类的static 方法／static 字段首次访问时，Java 解释器</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">必须找到Dog.class（在事先设好的类路径里搜索）。</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">(2) 找到Dog.class 后（它会创建一个Class 对象，这将在后面学到），它的所有static 初始化模块都会运</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">行。因此，static 初始化仅发生一次——在Class 对象首次载入的时候。</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">(3) 创建一个new Dog()时，Dog 对象的构建进程首先会在内存堆（Heap）里为一个Dog 对象分配足够多的存</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">储空间。</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">(4) 这种存储空间会清为零，将Dog 中的所有基本类型设为它们的默认值（零用于数字，以及boolean 和</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">char 的等价设定）。</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">(5) 进行字段定义时发生的所有初始化都会执行。</span></font></div><div align="left" style="min-height: 12pt;"><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">(6) 执行构建器。正如第6 章将要讲到的那样，这实际可能要求进行相当多的操作，特别是在涉及继承的时</span></font></div><div align="left" style="min-height: 12pt;"><div><font color="#010101" face="宋体" size="2"><span style="font-size:10pt">候。</span></font></div></div></div></span>
</div></body></html> 