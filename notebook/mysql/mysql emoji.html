<html>
<head>
  <title>mysql emoji</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/304720 (zh-CN, DDL); Windows/10.0.14393 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="349"/>
<h1>mysql emoji</h1>

<div><span><a href="http://segmentfault.com/a/1190000000616820">http://segmentfault.com/a/1190000000616820</a><div><br/></div><h2 style="margin: 28px 0px 18px; color: rgb(51, 51, 51); line-height: 1.2; padding-bottom: 8px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 1.42em; border-bottom-color: rgb(204, 204, 204); border-bottom-width: 1px; border-bottom-style: dotted; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">前言：</h2><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">最近开发的iOS项目因为需要用户文本的存储，自然就遇到了emoji等表情符号如何被mysql DB支持的问题。困扰了数日，在就要绝望放弃的边缘，终于完成了转换和迁移。在此特别分析和整理，方便更多人。</p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);"> </p><h2 style="margin: 28px 0px 18px; color: rgb(51, 51, 51); line-height: 1.2; padding-bottom: 8px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 1.42em; border-bottom-color: rgb(204, 204, 204); border-bottom-width: 1px; border-bottom-style: dotted; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">问题描述：</h2><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">如果UTF8字符集且是Java服务器的话，当存储含有emoji表情时，会抛出类似如下异常：</p><div><pre style="padding: 10px; border-radius: 3px; border: currentColor; border-image: none; color: rgb(101, 123, 131); line-height: 1.3; overflow: auto; font-family: Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace; font-size: 0.92em; margin-top: 18px; margin-bottom: 18px; position: relative; -ms-word-break: break-all; -ms-word-wrap: break-word; max-height: 500px; box-sizing: border-box; widows: 1; background-color: rgb(246, 246, 246);">java.sql.SQLException: Incorrect <font color="rgb(133,153,0)"><span style="box-sizing: border-box;">string</span></font><font color="rgb(133,153,0)"><span style="box-sizing: border-box;">value</span></font>: <font color="rgb(42,161,152)"><span style="box-sizing: border-box;">'\xF0\x9F\x92\x94'</span></font><font color="rgb(133,153,0)"><span style="box-sizing: border-box;">for</span></font> column <font color="rgb(42,161,152)"><span style="box-sizing: border-box;">'name'</span></font> at row <font color="rgb(42,161,152)"><span style="box-sizing: border-box;">1</span></font>  
    at com.<a href="http://www.2cto.com/database/MySQL/" style="background: none; outline: 0px; color: rgb(0, 142, 89); text-decoration: none; box-sizing: border-box;" target="_blank">mysql</a>.jdbc.SQLError.createSQLException(SQLError.java:<font color="rgb(42,161,152)"><span style="box-sizing: border-box;">1073</span></font>)  
    at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:<font color="rgb(42,161,152)"><span style="box-sizing: border-box;">3593</span></font>)  
    at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:<font color="rgb(42,161,152)"><span style="box-sizing: border-box;">3525</span></font>)  
    at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:<font color="rgb(42,161,152)"><span style="box-sizing: border-box;">1986</span></font>)  
    at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:<font color="rgb(42,161,152)"><span style="box-sizing: border-box;">2140</span></font>)  
    at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:<font color="rgb(42,161,152)"><span style="box-sizing: border-box;">2620</span></font>)  
    at com.mysql.jdbc.StatementImpl.executeUpdate(StatementImpl.java:<font color="rgb(42,161,152)"><span style="box-sizing: border-box;">1662</span></font>)  
    at com.mysql.jdbc.StatementImpl.executeUpdate(StatementImpl.java:<font color="rgb(42,161,152)"><span style="box-sizing: border-box;">1581</span></font>)
</pre></div><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">这就是字符集不支持的异常。因为UTF-8编码有可能是两个、三个、四个字节，其中Emoji表情是4个字节，而Mysql的utf8编码最多3个字节，所以导致了数据插不进去。</p><h2 style="margin: 28px 0px 18px; color: rgb(51, 51, 51); line-height: 1.2; padding-bottom: 8px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 1.42em; border-bottom-color: rgb(204, 204, 204); border-bottom-width: 1px; border-bottom-style: dotted; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);"></h2><h2 style="margin: 28px 0px 18px; color: rgb(51, 51, 51); line-height: 1.2; padding-bottom: 8px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 1.42em; border-bottom-color: rgb(204, 204, 204); border-bottom-width: 1px; border-bottom-style: dotted; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">升级前需要考虑的问题：</h2><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">如果你的项目要进行移动产品的用户文本的存储，将你的DB字符集从UTF8/GBK等传统字符集升级到utf8mb4将是势在必行。你可以通过应用层面转换emoji等特殊字符，以达到原DB的兼容，我认为可行，但是你可能走了弯路。</p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">utf8mb4作为utf8的super set，完全向下兼容，所以不用担心字符的兼容性问题。切换中需要顾虑的主要影响是mysql需要重新启动（虽然mysql官方文档说可以动态修改配置，但是经过数次测试，还是需要重启才可生效），对于业务可用率的影响是需要考虑的大问题，这里就暂时不展开讨论了。</p><h2 style="margin: 28px 0px 18px; color: rgb(51, 51, 51); line-height: 1.2; padding-bottom: 8px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 1.42em; border-bottom-color: rgb(204, 204, 204); border-bottom-width: 1px; border-bottom-style: dotted; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">升级步骤：</h2><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);"><strong style="box-sizing: border-box;">1.utf8mb4的最低mysql版本支持版本为5.5.3+，若不是，请升级到较新版本。</strong></p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">mysql版本查看命令请看：<a href="http://www.cnblogs.com/end/archive/2011/10/18/2216461.html" style="background: none; outline: 0px; color: rgb(0, 142, 89); text-decoration: none; box-sizing: border-box;" target="_blank" title="查看mysql版本的四种方法">查看mysql版本的四种方法</a>；mysql安装步骤请看：<a href="http://www.111cn.net/sys/linux/61026.htm" style="background: none; outline: 0px; color: rgb(0, 142, 89); text-decoration: none; box-sizing: border-box;" target="_blank" title="Linux中升级Mysql到Mysql最新版本的方法">Linux中升级Mysql到Mysql最新版本的方法</a><br style="box-sizing: border-box;"/><strong style="box-sizing: border-box;">2.修改database、table和column字符集。</strong>参考以下语句：<br style="box-sizing: border-box;"/>
ALTER DATABASE database_name CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;<br style="box-sizing: border-box;"/>
ALTER TABLE table_name CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;<br style="box-sizing: border-box;"/>
ALTER TABLE table_name CHANGE column_name VARCHAR(191) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;<br style="box-sizing: border-box;"/><strong style="box-sizing: border-box;">3.修改mysql配置文件my.cnf（windows为my.ini）</strong></p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">my.cnf一般在etc/mysql/my.cnf位置。找到后请在以下三部分里添加如下内容：</p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">[client]<br style="box-sizing: border-box;"/>
default-character-set = utf8mb4</p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">[mysql]<br style="box-sizing: border-box;"/>
default-character-set = utf8mb4</p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">[mysqld]<br style="box-sizing: border-box;"/>
character-set-client-handshake = FALSE<br style="box-sizing: border-box;"/>
character-set-server = utf8mb4<br style="box-sizing: border-box;"/>
collation-server = utf8mb4_unicode_ci<br style="box-sizing: border-box;"/>
init_connect='SET NAMES utf8mb4'</p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);"><strong style="box-sizing: border-box;">4.重启 MySQL Server、检查字符集</strong></p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">1.）重启命令参考：/etc/init.d/mysql restart</p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">2.）输入命令：mysql，进入mysql命令行（如果提示没权限，可以尝试输入mysql -uroot -p你的密码）</p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">3.）在mysql命令行中输入：SHOW VARIABLES WHERE Variable_name LIKE 'character_set_%' OR Variable_name LIKE 'collation%';</p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">检查是否如下：</p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">+--------------------------+--------------------+<br style="box-sizing: border-box;"/>
| Variable_name            | Value              |<br style="box-sizing: border-box;"/>
+--------------------------+--------------------+<br style="box-sizing: border-box;"/>
| character_set_client    | utf8mb4            |<br style="box-sizing: border-box;"/>
| character_set_connection | utf8mb4            |<br style="box-sizing: border-box;"/>
| character_set_database  | utf8mb4            |<br style="box-sizing: border-box;"/>
| character_set_filesystem | binary            |<br style="box-sizing: border-box;"/>
| character_set_results    | utf8mb4            |<br style="box-sizing: border-box;"/>
| character_set_server    | utf8mb4            |<br style="box-sizing: border-box;"/>
| character_set_system    | utf8              |<br style="box-sizing: border-box;"/>
| collation_connection    | utf8mb4_unicode_ci |<br style="box-sizing: border-box;"/>
| collation_database      | utf8mb4_unicode_ci |<br style="box-sizing: border-box;"/>
| collation_server        | utf8mb4_unicode_ci |<br style="box-sizing: border-box;"/>
+--------------------------+--------------------+<br style="box-sizing: border-box;"/>
rows in set (0.00 sec)</p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">特别说明下：collation_connection/collation_database/collation_server如果是utf8mb4_general_ci，没有关系。但必须保证character_set_client/character_set_connection/character_set_database/character_set_results/character_set_server为utf8mb4。关于这些字符集配置是干什么用的，有什么区别，请参考：<a href="http://www.laruence.com/2008/01/05/12.html" style="background: none; outline: 0px; color: rgb(0, 142, 89); text-decoration: none; box-sizing: border-box;" target="_blank" title="深入Mysql字符集设置">深入Mysql字符集设置</a></p><div style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);"><strong style="box-sizing: border-box;">5.如果你用的是java服务器，升级或确保你的mysql connector版本高于5.1.13，否则仍然无法使用utf8mb4</strong><br style="box-sizing: border-box;"/>
这是mysql官方<a href="http://dev.mysql.com/doc/relnotes/connector-j/en/news-5-1-13.html" style="background: none; outline: 0px; color: rgb(0, 142, 89); text-decoration: none; box-sizing: border-box;" target="_blank">release note</a>，大家可以查看说明，并下载最新的mysql connector for java的jar包。<br style="box-sizing: border-box;"/>
这里为大家提供一个：<a href="http://www.ilikewhite.com/wp-content/uploads/2014/07/mysql-connector-java-5.1.31-bin.zip" style="background: none; outline: 0px; color: rgb(0, 142, 89); text-decoration: none; box-sizing: border-box;" target="_blank">mysql-connector-java-5.1.31-bin.jar</a><br style="box-sizing: border-box;"/>
同时记得修改pom配置哦~</div><div style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);"><br/></div><div style="margin: 18px 0px; line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);"><font color="#ff0000">数据源配置文件下添加</font></div><div style="margin: 18px 0px; line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);"><font color="rgb(69,69,69)" face="arial, 宋体, sans-serif, tahoma, &quot;Microsoft YaHei&quot;"><span style="text-transform: none; line-height: 24px; text-indent: 0px; letter-spacing: normal; font-size: 14px; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; widows: 1; font-size-adjust: none; font-stretch: normal; background-color: rgb(255, 255, 255); -webkit-text-stroke-width: 0px;"><font color="#ff0000">&lt;property name=&quot;connectionInitSqls&quot; value=&quot;set names utf8mb4；&quot; /&gt;</font></span></font></div><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);"><strong style="box-sizing: border-box;">6.检查你服务端的db配置文件：</strong></p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);"> </p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">jdbc.driverClassName=com.mysql.jdbc.Driver<br style="box-sizing: border-box;"/>
jdbc.url=jdbc:mysql://localhost:3306/database?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;rewriteBatchedStatements=TRUE<br style="box-sizing: border-box;"/>
jdbc.username=root<br style="box-sizing: border-box;"/>
jdbc.password=password</p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);"> </p><p style="margin: 18px 0px; color: rgb(51, 51, 51); line-height: 22.39px; font-family: &quot;Open Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, STHeiti, &quot;Microsoft Yahei&quot;, sans-serif; font-size: 14px; box-sizing: border-box; widows: 1; background-color: rgb(255, 255, 255);">特别说明其中的jdbc.url配置：如果你已经升级好了mysql-connector，其中的characterEncoding=utf8可以被自动被识别为utf8mb4（当然也兼容原来的utf8），而autoReconnect配置我强烈建议配上，我之前就是忽略了这个属性，导致因为缓存缘故，没有读取到DB最新配置，导致一直无法使用utf8mb4字符集，多么痛的领悟！！</p><div><br/></div></span>
</div></body></html> 