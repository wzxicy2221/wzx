<html>
<head>
  <title>微信jssdk上传多张图片时处理</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/304720 (zh-CN, DDL); Windows/10.0.14393 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="409"/>
<h1>微信jssdk上传多张图片时处理</h1>

<div>
<span><div><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);">做过微信开发的都知道，在部分android机型里微信不支持网页上传图片的，这是由于这些机型的文件上传存在内存泄漏，会导致微信闪退，所以微信内置浏览器将文件上传屏蔽。这就导致这些机型的用户在使用微信浏览器访问某些需要上传图片的网页时功能不正常。 <a href="http://leo108.com/pid-2069.asp" rel="nofollow,noindex" style="color: rgb(148, 148, 148); text-decoration: none; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;">微信</a></p><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);">前不久微信公开了一些接口，其中有一个uploadImage接口用于上传图片，一般和chooseImage接口配合使用。先调用chooseImage接口让用户选择一张或者多张图片，用户选择完毕后微信会返回被选中图片的id，再把图片id传给uploadImage接口上传图片。 <a href="http://leo108.com/pid-2069.asp" rel="nofollow,noindex" style="color: rgb(148, 148, 148); text-decoration: none; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;">无耻推酷</a></p><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);">由于uploadImage一次只能上传一张图片，因此当用户选择多张图片时，需要多次调用uploadImage接口来上传图片。</p><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);"><a href="http://leo108.com/pid-2069.asp" rel="nofollow,noindex" style="color: rgb(148, 148, 148); text-decoration: none; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;">jssdk</a></p><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);">但是在实践的过程中发现，不管用户选中多少张图片，只有第一张能够上传成功。<a href="http://leo108.com/pid-2069.asp" rel="nofollow,noindex" style="color: rgb(148, 148, 148); text-decoration: none; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;">无耻推酷</a></p><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);">查看了一下微信的文档，在常见问题中找到了相关的描述 <a href="http://leo108.com/pid-2069.asp" rel="nofollow,noindex" style="color: rgb(148, 148, 148); text-decoration: none; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;">本文来自http://leo108.com</a></p><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);"></p><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);">uploadImage怎么传多图（目前只支持一次上传一张，多张图片需等前一张图片上传之后再调用该接口）</p><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);"><a href="http://leo108.com/pid-2069.asp" rel="nofollow,noindex" style="color: rgb(148, 148, 148); text-decoration: none; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;">jssdk</a></p><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);"></p><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);">也就是说，如果想要上传多张图片，需要将之前并行上传改成串行。</p><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);"><a href="http://leo108.com/pid-2069.asp" rel="nofollow,noindex" style="color: rgb(148, 148, 148); text-decoration: none; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;">微信</a></p><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);">代码如下：</p><p style="margin: 0px 0px 0.75em; font-size: 16px; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(254, 254, 254);"><a href="http://leo108.com/pid-2069.asp" rel="nofollow,noindex" style="color: rgb(148, 148, 148); text-decoration: none; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;">jssdk</a></p><div style="padding: 0.3em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(51, 51, 51); border-radius: 4px; display: block; margin: 0px 0px 1.5em; font-size: 12px; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(246, 246, 246);">$(<span style="color: rgb(221, 17, 68);">'#filePicker'</span>).on(<span style="color: rgb(221, 17, 68);">'click'</span>, <span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> () {  wx.chooseImage({<br/>
    success: <span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> (res) {      <span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> localIds = res.localIds;<br/>
      syncUpload(localIds);<br/>
    }<br/>
  });<br/>
});<br/><span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> syncUpload = <span style="color: rgb(51, 51, 51); font-weight: bold;">function</span>(localIds){<br/>
  <span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> localId = localIds.pop();<br/>
  wx.uploadImage({<br/>
    localId: localId,<br/>
    isShowProgressTips: <span style="color: rgb(0, 153, 153);">1</span>,
<div>    success: <span style="color: rgb(51, 51, 51); font-weight: bold;">function</span> (res) {      <span style="color: rgb(51, 51, 51); font-weight: bold;">var</span> serverId = res.serverId; <span style="color: rgb(153, 153, 136); font-style: italic;">// 返回图片的服务器端ID</span>      <span style="color: rgb(153, 153, 136); font-style: italic;">//其他对serverId做处理的代码</span>     </div><div><span style="color: rgb(51, 51, 51); font-weight: bold;">     if</span>(localIds.length &gt; <span style="color: rgb(0, 153, 153);">0</span>){</div>
        syncUpload(localIds);<br/>
      }<br/>
    }<br/>
  });<br/>
};<br/></div></div></span>
</div></body></html> 